<!doctype html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Articles to MP3 - Selector</title>
        <link
            href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Work+Sans:wght@300;400;600;800&display=swap"
            rel="stylesheet"
        />
        <style>
            :root {
                --bg-primary: #0a0a0a;
                --bg-secondary: #1a1a1a;
                --bg-tertiary: #2a2a2a;
                --bg-quaternary: #353535;
                --accent: #00ff88;
                --accent-dim: #00cc6a;
                --text-primary: #ffffff;
                --text-secondary: #aaaaaa;
                --text-dim: #666666;
                --border: #333333;
                --warning: #ffaa00;
                --danger: #ff4444;
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: "Work Sans", sans-serif;
                background: var(--bg-primary);
                color: var(--text-primary);
                line-height: 1.6;
                overflow-x: hidden;
            }

            .header {
                background: var(--bg-secondary);
                border-bottom: 2px solid var(--accent);
                padding: 2rem;
                position: sticky;
                top: 0;
                z-index: 100;
                backdrop-filter: blur(10px);
            }

            .header-content {
                max-width: 1400px;
                margin: 0 auto;
            }

            h1 {
                font-family: "Space Mono", monospace;
                font-size: 2.5rem;
                font-weight: 700;
                letter-spacing: -0.02em;
                margin-bottom: 0.5rem;
            }

            .accent-text {
                color: var(--accent);
            }

            .subtitle {
                color: var(--text-secondary);
                font-size: 1rem;
                font-weight: 300;
            }

            /* Opciones globales */
            .global-options {
                margin-top: 1.5rem;
                padding: 1.5rem;
                background: var(--bg-tertiary);
                border-radius: 4px;
                border-left: 3px solid var(--accent);
            }

            .options-title {
                font-family: "Space Mono", monospace;
                font-size: 0.9rem;
                color: var(--accent);
                margin-bottom: 1rem;
                text-transform: uppercase;
                letter-spacing: 0.1em;
            }

            .options-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 1rem;
            }

            .option-item {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }

            .option-label {
                font-size: 0.75rem;
                color: var(--text-dim);
                text-transform: uppercase;
                letter-spacing: 0.1em;
                font-family: "Space Mono", monospace;
            }

            .option-item select,
            .option-item input[type="text"] {
                padding: 0.5rem;
                background: var(--bg-secondary);
                border: 1px solid var(--border);
                color: var(--text-primary);
                font-family: "Work Sans", sans-serif;
                font-size: 0.9rem;
                transition: border-color 0.2s ease;
            }

            .option-item select:focus,
            .option-item input[type="text"]:focus {
                outline: none;
                border-color: var(--accent);
            }

            .option-checkbox {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .option-checkbox input[type="checkbox"] {
                width: 18px;
                height: 18px;
                cursor: pointer;
                accent-color: var(--accent);
            }

            .option-checkbox label {
                font-size: 0.85rem;
                color: var(--text-secondary);
                cursor: pointer;
            }

            .stats-bar {
                display: flex;
                gap: 2rem;
                margin-top: 1.5rem;
                padding: 1rem;
                background: var(--bg-tertiary);
                border-radius: 4px;
                border-left: 3px solid var(--accent);
            }

            .stat {
                display: flex;
                flex-direction: column;
            }

            .stat-label {
                font-size: 0.75rem;
                color: var(--text-dim);
                text-transform: uppercase;
                letter-spacing: 0.1em;
                font-family: "Space Mono", monospace;
            }

            .stat-value {
                font-size: 1.5rem;
                font-weight: 800;
                color: var(--accent);
            }

            .container {
                max-width: 1400px;
                margin: 0 auto;
                padding: 2rem;
            }

            .controls {
                display: flex;
                gap: 1rem;
                margin-bottom: 2rem;
                flex-wrap: wrap;
            }

            .btn {
                padding: 0.75rem 1.5rem;
                background: var(--bg-tertiary);
                border: 2px solid var(--border);
                color: var(--text-primary);
                font-family: "Space Mono", monospace;
                font-size: 0.9rem;
                cursor: pointer;
                transition: all 0.2s ease;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }

            .btn:hover {
                border-color: var(--accent);
                background: var(--bg-secondary);
                transform: translateY(-2px);
            }

            .btn-primary {
                background: var(--accent);
                color: var(--bg-primary);
                border-color: var(--accent);
                font-weight: 700;
            }

            .btn-primary:hover {
                background: var(--accent-dim);
                border-color: var(--accent-dim);
            }

            .source-section {
                margin-bottom: 3rem;
                border: 1px solid var(--border);
                background: var(--bg-secondary);
                overflow: hidden;
            }

            .source-header {
                padding: 1.5rem;
                background: var(--bg-tertiary);
                display: flex;
                justify-content: space-between;
                align-items: center;
                cursor: pointer;
                user-select: none;
                transition: background 0.2s ease;
            }

            .source-header:hover {
                background: #333333;
            }

            .source-title {
                font-family: "Space Mono", monospace;
                font-size: 1.5rem;
                font-weight: 700;
                display: flex;
                align-items: center;
                gap: 1rem;
            }

            .source-badge {
                font-size: 0.75rem;
                padding: 0.25rem 0.75rem;
                background: var(--accent);
                color: var(--bg-primary);
                border-radius: 20px;
                font-weight: 700;
            }

            /* Categor√≠a */
            .category-group {
                border-bottom: 1px solid var(--border);
            }

            .category-group:last-child {
                border-bottom: none;
            }

            .category-header {
                padding: 1rem 1.5rem;
                background: var(--bg-secondary);
                display: flex;
                justify-content: space-between;
                align-items: center;
                cursor: pointer;
                user-select: none;
                transition: all 0.2s ease;
            }

            .category-header:hover {
                background: var(--bg-tertiary);
                padding-left: 2rem;
            }

            .category-name {
                font-weight: 600;
                font-size: 1.1rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .category-count {
                font-size: 0.8rem;
                color: var(--text-dim);
                font-family: "Space Mono", monospace;
            }

            /* Feed */
            .feed-group {
                border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            }

            .feed-group:last-child {
                border-bottom: none;
            }

            .feed-header {
                padding: 0.75rem 2.5rem;
                background: var(--bg-tertiary);
                display: flex;
                justify-content: space-between;
                align-items: center;
                cursor: pointer;
                user-select: none;
                transition: all 0.2s ease;
                border-left: 3px solid transparent;
            }

            .feed-header:hover {
                background: var(--bg-quaternary);
                padding-left: 3rem;
                border-left-color: var(--accent);
            }

            .feed-info {
                display: flex;
                align-items: center;
                gap: 1rem;
                flex: 1;
            }

            .feed-checkbox-wrapper {
                display: flex;
                align-items: center;
            }

            .feed-checkbox {
                width: 20px;
                height: 20px;
                cursor: pointer;
                accent-color: var(--accent);
            }

            .feed-name {
                font-weight: 500;
                font-size: 1rem;
                color: var(--text-secondary);
            }

            .feed-count {
                font-size: 0.75rem;
                color: var(--text-dim);
                font-family: "Space Mono", monospace;
            }

            .feed-toggle {
                color: var(--accent);
                font-size: 1.2rem;
                transition: transform 0.2s ease;
            }

            .feed-toggle.active {
                transform: rotate(90deg);
            }

            /* Articles list */
            .articles-list {
                display: none;
            }

            .articles-list.active {
                display: block;
            }

            .article-item {
                padding: 1rem 3.5rem;
                background: var(--bg-secondary);
                border-bottom: 1px solid rgba(255, 255, 255, 0.03);
                display: flex;
                flex-direction: column;
                gap: 1rem;
                cursor: pointer;
                transition: all 0.2s ease;
            }

            .article-item:hover {
                background: var(--bg-tertiary);
                padding-left: 4rem;
            }

            .article-main {
                display: flex;
                gap: 1rem;
                align-items: start;
            }

            .checkbox-wrapper {
                padding-top: 0.2rem;
            }

            .checkbox {
                width: 18px;
                height: 18px;
                cursor: pointer;
                accent-color: var(--accent);
            }

            .article-content {
                flex: 1;
            }

            .article-title {
                font-weight: 500;
                margin-bottom: 0.5rem;
                color: var(--text-primary);
            }

            .article-meta {
                display: flex;
                gap: 1.5rem;
                font-size: 0.85rem;
                color: var(--text-dim);
                flex-wrap: wrap;
            }

            .meta-item {
                display: flex;
                align-items: center;
                gap: 0.25rem;
            }

            /* Opciones del art√≠culo */
            .article-options {
                display: none;
                padding: 1rem;
                padding-left: 2rem;
                background: rgba(0, 255, 136, 0.05);
                border-left: 2px solid var(--accent);
                margin-left: 2rem;
            }

            .article-item.selected .article-options {
                display: block;
            }

            .article-options-title {
                font-size: 0.75rem;
                color: var(--accent);
                text-transform: uppercase;
                letter-spacing: 0.1em;
                font-family: "Space Mono", monospace;
                margin-bottom: 0.75rem;
            }

            .article-options-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 0.75rem;
            }

            .article-option {
                display: flex;
                flex-direction: column;
                gap: 0.35rem;
            }

            .article-option label {
                font-size: 0.7rem;
                color: var(--text-dim);
                text-transform: uppercase;
                letter-spacing: 0.05em;
                font-family: "Space Mono", monospace;
            }

            .article-option select {
                padding: 0.4rem;
                background: var(--bg-secondary);
                border: 1px solid var(--border);
                color: var(--text-primary);
                font-size: 0.85rem;
                transition: border-color 0.2s ease;
            }

            .article-option select:focus {
                outline: none;
                border-color: var(--accent);
            }

            .article-option-checkbox {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                padding-top: 0.5rem;
            }

            .article-option-checkbox input {
                width: 16px;
                height: 16px;
                cursor: pointer;
                accent-color: var(--accent);
            }

            .article-option-checkbox label {
                font-size: 0.8rem;
                color: var(--text-secondary);
                text-transform: none;
                letter-spacing: normal;
                cursor: pointer;
            }

            .toggle-icon {
                color: var(--accent);
                font-size: 1.2rem;
                transition: transform 0.2s ease;
            }

            .toggle-icon.active {
                transform: rotate(90deg);
            }

            .action-panel {
                position: fixed;
                bottom: 2rem;
                right: 2rem;
                background: var(--bg-tertiary);
                border: 2px solid var(--accent);
                padding: 1.5rem;
                border-radius: 4px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
                display: none;
                z-index: 1000;
            }

            .action-panel h3 {
                font-family: "Space Mono", monospace;
                font-size: 1rem;
                margin-bottom: 1rem;
                color: var(--accent);
            }

            .action-stats {
                margin-bottom: 1rem;
                font-size: 0.9rem;
                color: var(--text-secondary);
            }

            .action-buttons {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }

            .search-box {
                margin-bottom: 1.5rem;
            }

            .search-box input {
                width: 100%;
                padding: 0.75rem;
                background: var(--bg-tertiary);
                border: 1px solid var(--border);
                color: var(--text-primary);
                font-family: "Work Sans", sans-serif;
                font-size: 1rem;
                transition: border-color 0.2s ease;
            }

            .search-box input:focus {
                outline: none;
                border-color: var(--accent);
            }

            /* Modal de progreso */
            .progress-modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                z-index: 2000;
                align-items: center;
                justify-content: center;
            }

            .progress-content {
                background: var(--bg-secondary);
                border: 2px solid var(--accent);
                border-radius: 8px;
                padding: 3rem;
                max-width: 600px;
                width: 90%;
            }

            .progress-title {
                font-family: "Space Mono", monospace;
                font-size: 1.5rem;
                color: var(--accent);
                margin-bottom: 2rem;
                text-align: center;
            }

            .progress-bar-container {
                background: var(--bg-tertiary);
                border-radius: 4px;
                height: 30px;
                margin-bottom: 1rem;
                overflow: hidden;
                border: 1px solid var(--border);
            }

            .progress-bar {
                height: 100%;
                background: linear-gradient(
                    90deg,
                    var(--accent-dim),
                    var(--accent)
                );
                width: 0%;
                transition: width 0.3s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                color: var(--bg-primary);
                font-family: "Space Mono", monospace;
                font-weight: 700;
            }

            .progress-message {
                color: var(--text-secondary);
                text-align: center;
                margin-top: 1rem;
                min-height: 60px;
            }

            .progress-spinner {
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 3px solid rgba(0, 255, 136, 0.3);
                border-top-color: var(--accent);
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-right: 10px;
            }

            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }

            @media (max-width: 768px) {
                .options-grid {
                    grid-template-columns: 1fr;
                }

                .article-options-grid {
                    grid-template-columns: 1fr;
                }
            }
        </style>
    </head>
    <body>
        <div class="header">
            <div class="header-content">
                <h1><span class="accent-text">‚ô™</span> Articles to MP3</h1>
                <p class="subtitle">
                    Selecciona art√≠culos y configura opciones de conversi√≥n
                </p>

                <!-- Opciones Globales -->
                <div class="global-options">
                    <div class="options-title">‚öô Opciones Globales</div>
                    <div class="options-grid">
                        <div class="option-item">
                            <label class="option-label"
                                >üé§ Voz por Defecto</label
                            >
                            <select id="default-voice">
                                <optgroup label="Espa√±ol">
                                    <option value="es-ES-AlvaroNeural" selected>
                                        Alvaro (Espa√±a, H)
                                    </option>
                                    <option value="es-ES-ElviraNeural">
                                        Elvira (Espa√±a, M)
                                    </option>
                                    <option value="es-ES-AbrilNeural">
                                        Abril (Espa√±a, M)
                                    </option>
                                    <option value="es-MX-DaliaNeural">
                                        Dalia (M√©xico, M)
                                    </option>
                                    <option value="es-MX-JorgeNeural">
                                        Jorge (M√©xico, H)
                                    </option>
                                    <option value="es-AR-ElenaNeural">
                                        Elena (Argentina, M)
                                    </option>
                                    <option value="es-AR-TomasNeural">
                                        Tom√°s (Argentina, H)
                                    </option>
                                </optgroup>
                                <optgroup label="Ingl√©s">
                                    <option value="en-US-AriaNeural">
                                        Aria (US, M)
                                    </option>
                                    <option value="en-US-GuyNeural">
                                        Guy (US, H)
                                    </option>
                                    <option value="en-GB-SoniaNeural">
                                        Sonia (UK, M)
                                    </option>
                                    <option value="en-GB-RyanNeural">
                                        Ryan (UK, H)
                                    </option>
                                </optgroup>
                            </select>
                        </div>

                        <div class="option-item">
                            <label class="option-label"
                                >üåç Idioma del Audio</label
                            >
                            <select id="default-language">
                                <option value="es" selected>Espa√±ol</option>
                                <option value="en">English</option>
                                <option value="fr">Fran√ßais</option>
                                <option value="de">Deutsch</option>
                                <option value="it">Italiano</option>
                                <option value="pt">Portugu√™s</option>
                            </select>
                        </div>

                        <div class="option-item">
                            <label class="option-label">üéõ Motor TTS</label>
                            <select id="tts-engine">
                                <option value="edge" selected>
                                    Edge TTS (mejor calidad)
                                </option>
                                <option value="gtts">
                                    Google TTS (m√°s r√°pido)
                                </option>
                            </select>
                        </div>

                        <div class="option-item">
                            <label class="option-label">üì∫ YouTube</label>
                            <div class="option-checkbox">
                                <input type="checkbox" id="default-youtube" />
                                <label for="default-youtube"
                                    >Incluir videos por defecto</label
                                >
                            </div>
                        </div>
                    </div>
                </div>

                <div class="stats-bar">
                    <div class="stat">
                        <span class="stat-label">Total</span>
                        <span class="stat-value" id="totalArticles">0</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Seleccionados</span>
                        <span class="stat-value" id="selectedCount">0</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Palabras</span>
                        <span class="stat-value" id="estimatedWords">0</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="search-box">
                <input
                    type="text"
                    id="searchFilter"
                    placeholder="üîç Buscar art√≠culos..."
                    oninput="filterArticles()"
                />
            </div>

            <div class="controls">
                <button class="btn" onclick="selectAll()">
                    Seleccionar Todos
                </button>
                <button class="btn" onclick="deselectAll()">
                    Deseleccionar Todos
                </button>
                <button class="btn" onclick="downloadSelectionJson()">
                    üíæ Descargar JSON
                </button>
            </div>

            <div id="sourcesContainer">
                <!-- Se llenar√° din√°micamente -->
            </div>
        </div>

        <!-- Panel de acci√≥n flotante -->
        <div class="action-panel" id="actionPanel">
            <h3>ACCI√ìN</h3>
            <div class="action-stats">
                <div>
                    <strong id="actionCount">0</strong> art√≠culos seleccionados
                </div>
                <div>~<strong id="actionWords">0</strong> palabras</div>
            </div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="saveToServer()">
                    üéµ CONVERTIR A MP3
                </button>
            </div>
        </div>

        <!-- Modal de progreso -->
        <div class="progress-modal" id="progressModal">
            <div class="progress-content">
                <div class="progress-title">CONVERSI√ìN EN PROGRESO</div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar">
                        <span id="progressText">0%</span>
                    </div>
                </div>
                <div class="progress-message">
                    <span class="progress-spinner"></span>
                    <span id="progressMessage">Iniciando...</span>
                </div>
            </div>
        </div>

        <script>
            let articlesData = null;
            let selectedArticlesData = {};

            async function loadData() {
                try {
                    const response = await fetch("/api/articles_data.json");
                    articlesData = await response.json();
                    renderSources();
                    updateCounts();
                } catch (error) {
                    console.error("Error cargando datos:", error);
                    alert(
                        "Error al cargar los art√≠culos. Verifica que el servidor est√© corriendo.",
                    );
                }
            }

            function renderSources() {
                const container = document.getElementById("sourcesContainer");
                let html = "";

                // Wallabag
                if (articlesData.wallabag && articlesData.wallabag.enabled) {
                    html += renderWallabag();
                }

                // FreshRSS
                if (articlesData.freshrss && articlesData.freshrss.enabled) {
                    html += renderFreshRSS();
                }

                container.innerHTML = html;
            }

            function renderWallabag() {
                const articles = articlesData.wallabag.articles || [];
                if (!articles.length) return "";

                let html = `
                    <div class="source-section">
                        <div class="source-header" onclick="toggleSourceContent(this)">
                            <div class="source-title">
                                <span>üìö WALLABAG</span>
                                <span class="source-badge">${articles.length}</span>
                            </div>
                            <span class="toggle-icon">‚ñ∂</span>
                        </div>
                        <div class="category-group">
                `;

                articles.forEach((article) => {
                    html += renderArticle(article, "wallabag", "", "");
                });

                html += `</div></div>`;
                return html;
            }

            function renderFreshRSS() {
                const categories = articlesData.freshrss.categories || [];
                if (!categories.length) return "";

                let totalArticles = 0;
                categories.forEach((cat) => {
                    cat.feeds.forEach((feed) => {
                        totalArticles += feed.articles.length;
                    });
                });

                let html = `
                    <div class="source-section">
                        <div class="source-header" onclick="toggleSourceContent(this)">
                            <div class="source-title">
                                <span>üì∞ FRESHRSS</span>
                                <span class="source-badge">${totalArticles}</span>
                            </div>
                            <span class="toggle-icon">‚ñ∂</span>
                        </div>
                `;

                categories.forEach((category) => {
                    html += renderCategory(category);
                });

                html += `</div>`;
                return html;
            }

            function renderCategory(category) {
                let totalArticles = 0;
                category.feeds.forEach((feed) => {
                    totalArticles += feed.articles.length;
                });

                let html = `
                    <div class="category-group">
                        <div class="category-header" onclick="toggleCategoryContent(this)">
                            <div class="category-name">
                                <span>üìÅ ${escapeHtml(category.name)}</span>
                                <span class="category-count">${totalArticles}</span>
                            </div>
                            <span class="toggle-icon">‚ñ∂</span>
                        </div>
                `;

                category.feeds.forEach((feed) => {
                    html += renderFeed(feed, category.name);
                });

                html += `</div>`;
                return html;
            }

            function renderFeed(feed, categoryName) {
                let html = `
                    <div class="feed-group">
                        <div class="feed-header" onclick="toggleFeedContent(this)">
                            <div class="feed-info">
                                <div class="feed-checkbox-wrapper" onclick="event.stopPropagation()">
                                    <input type="checkbox" class="feed-checkbox"
                                           onchange="toggleFeedArticles(this, '${categoryName}', '${feed.id}')" />
                                </div>
                                <span class="feed-name">${escapeHtml(feed.title)}</span>
                                <span class="feed-count">${feed.articles.length}</span>
                            </div>
                            <span class="feed-toggle">‚ñ∂</span>
                        </div>
                        <div class="articles-list">
                `;

                feed.articles.forEach((article) => {
                    html += renderArticle(
                        article,
                        "freshrss",
                        categoryName,
                        feed.id,
                    );
                });

                html += `</div></div>`;
                return html;
            }

            function renderArticle(article, source, categoryName, feedId) {
                const articleId =
                    `${source}_${categoryName}_${feedId}_${article.id}`.replace(
                        /[^a-zA-Z0-9_-]/g,
                        "_",
                    );

                return `
                    <div class="article-item" id="article_${articleId}">
                        <div class="article-main">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" class="checkbox"
                                       id="${articleId}"
                                       data-source="${source}"
                                       data-category="${escapeHtml(categoryName)}"
                                       data-original-feed-id="${escapeHtml(feedId)}"
                                       data-article-id="${escapeHtml(article.id)}"
                                       data-word-count="${article.word_count || 0}"
                                       onchange="toggleArticle(this, '${articleId}', '${source}', '${escapeHtml(article.id)}', '${escapeHtml(categoryName)}', '${escapeHtml(feedId)}', '${escapeHtml(article.title)}')" />
                            </div>
                            <div class="article-content">
                                <div class="article-title">${escapeHtml(article.title)}</div>
                                <div class="article-meta">
                                    <span class="meta-item">üìä ${(article.word_count || 0).toLocaleString()} palabras</span>
                                    <span class="meta-item">üìù ${(article.char_count || 0).toLocaleString()} caracteres</span>
                                    ${article.published ? `<span class="meta-item">üìÖ ${new Date(article.published * 1000).toLocaleDateString()}</span>` : ""}
                                </div>
                            </div>
                        </div>
                        <div class="article-options">
                            <div class="article-options-title">‚öô Opciones de conversi√≥n</div>
                            <div class="article-options-grid">
                                <div class="article-option">
                                    <label>üé§ Voz</label>
                                    <select id="voice_${articleId}" onchange="updateArticleOption('${articleId}', 'voice', this.value)">
                                        <optgroup label="Espa√±ol">
                                            <option value="es-ES-AlvaroNeural">Alvaro (Espa√±a, H)</option>
                                            <option value="es-ES-ElviraNeural">Elvira (Espa√±a, M)</option>
                                            <option value="es-MX-DaliaNeural">Dalia (M√©xico, M)</option>
                                            <option value="es-MX-JorgeNeural">Jorge (M√©xico, H)</option>
                                        </optgroup>
                                        <optgroup label="Ingl√©s">
                                            <option value="en-US-GuyNeural">Guy (US, H)</option>
                                            <option value="en-US-AriaNeural">Aria (US, M)</option>
                                        </optgroup>
                                    </select>
                                </div>
                                <div class="article-option">
                                    <label>üåç Idioma</label>
                                    <select id="lang_${articleId}" onchange="updateArticleOption('${articleId}', 'language', this.value)">
                                        <option value="es">Espa√±ol</option>
                                        <option value="en">English</option>
                                        <option value="fr">Fran√ßais</option>
                                        <option value="de">Deutsch</option>
                                    </select>
                                </div>
                                <div class="article-option">
                                    <div class="article-option-checkbox">
                                        <input type="checkbox" id="youtube_${articleId}"
                                               onchange="updateArticleOption('${articleId}', 'include_youtube', this.checked)">
                                        <label for="youtube_${articleId}">üì∫ Incluir YouTube</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            function toggleArticle(
                checkbox,
                articleId,
                source,
                originalId,
                categoryName,
                feedId,
                title,
            ) {
                const articleEl = document.getElementById(
                    `article_${articleId}`,
                );

                if (checkbox.checked) {
                    articleEl.classList.add("selected");

                    // Inicializar opciones con valores por defecto
                    const defaultVoice =
                        document.getElementById("default-voice").value;
                    const defaultLanguage =
                        document.getElementById("default-language").value;
                    const defaultYouTube =
                        document.getElementById("default-youtube").checked;
                    const ttsEngine =
                        document.getElementById("tts-engine").value;

                    document.getElementById(`voice_${articleId}`).value =
                        defaultVoice;
                    document.getElementById(`lang_${articleId}`).value =
                        defaultLanguage;
                    document.getElementById(`youtube_${articleId}`).checked =
                        defaultYouTube;

                    selectedArticlesData[articleId] = {
                        source,
                        originalId,
                        categoryName,
                        feedId,
                        title,
                        voice: defaultVoice,
                        language: defaultLanguage,
                        include_youtube: defaultYouTube,
                        tts_engine: ttsEngine,
                    };
                } else {
                    articleEl.classList.remove("selected");
                    delete selectedArticlesData[articleId];
                }

                updateCounts();
            }

            function updateArticleOption(articleId, option, value) {
                if (selectedArticlesData[articleId]) {
                    selectedArticlesData[articleId][option] = value;
                }
            }

            function selectAll() {
                document
                    .querySelectorAll(".checkbox:not(:checked)")
                    .forEach((cb) => cb.click());
            }

            function deselectAll() {
                document
                    .querySelectorAll(".checkbox:checked")
                    .forEach((cb) => cb.click());
            }

            function toggleFeedArticles(checkbox, categoryName, feedId) {
                const feedGroup = checkbox.closest(".feed-group");
                const articleCheckboxes = feedGroup.querySelectorAll(
                    ".articles-list .checkbox",
                );

                articleCheckboxes.forEach((cb) => {
                    if (checkbox.checked && !cb.checked) {
                        cb.click();
                    } else if (!checkbox.checked && cb.checked) {
                        cb.click();
                    }
                });
            }

            function toggleSourceContent(header) {
                const icon = header.querySelector(".toggle-icon");
                const content = header.nextElementSibling;

                while (
                    content &&
                    !content.classList.contains("source-header")
                ) {
                    content.style.display =
                        content.style.display === "none" ? "block" : "none";
                    break;
                }

                icon.classList.toggle("active");
            }

            function toggleCategoryContent(header) {
                const icon = header.querySelector(".toggle-icon");
                const feeds =
                    header.parentElement.querySelectorAll(".feed-group");

                feeds.forEach((feed) => {
                    feed.style.display =
                        feed.style.display === "none" ? "block" : "none";
                });

                icon.classList.toggle("active");
            }

            function toggleFeedContent(header) {
                const icon = header.querySelector(".feed-toggle");
                const articles = header.nextElementSibling;

                articles.classList.toggle("active");
                icon.classList.toggle("active");
            }

            function updateCounts() {
                const count =
                    document.querySelectorAll(".checkbox:checked").length;
                let totalWords = 0;

                document.querySelectorAll(".checkbox:checked").forEach((cb) => {
                    totalWords += parseInt(cb.dataset.wordCount || 0);
                });

                document.getElementById("selectedCount").textContent = count;
                document.getElementById("estimatedWords").textContent =
                    totalWords.toLocaleString();
                document.getElementById("actionCount").textContent = count;
                document.getElementById("actionWords").textContent =
                    totalWords.toLocaleString();
                document.getElementById("actionPanel").style.display =
                    count > 0 ? "block" : "none";

                const totalArticles =
                    document.querySelectorAll(".checkbox").length;
                document.getElementById("totalArticles").textContent =
                    totalArticles;
            }

            function filterArticles() {
                const query = document
                    .getElementById("searchFilter")
                    .value.toLowerCase();
                document.querySelectorAll(".article-item").forEach((item) => {
                    const title = item
                        .querySelector(".article-title")
                        .textContent.toLowerCase();
                    item.style.display = title.includes(query)
                        ? "flex"
                        : "none";
                });
            }

            async function saveToServer() {
                const count = Object.keys(selectedArticlesData).length;

                if (count === 0) {
                    alert("‚ö† No hay art√≠culos seleccionados");
                    return;
                }

                try {
                    const selection = {
                        options: {
                            tts_engine:
                                document.getElementById("tts-engine").value,
                            default_voice:
                                document.getElementById("default-voice").value,
                            default_language:
                                document.getElementById("default-language")
                                    .value,
                            include_youtube:
                                document.getElementById("default-youtube")
                                    .checked,
                            generate_feed: true,
                            skip_existing: true,
                        },
                        wallabag: [],
                        freshrss: {
                            categories: {},
                        },
                    };

                    // Procesar art√≠culos seleccionados
                    for (const [articleId, data] of Object.entries(
                        selectedArticlesData,
                    )) {
                        if (data.source === "wallabag") {
                            const fullArticle =
                                articlesData.wallabag.articles.find(
                                    (a) => a.id == data.originalId,
                                );
                            if (fullArticle) {
                                selection.wallabag.push({
                                    id: fullArticle.id,
                                    title: fullArticle.title,
                                    voice: data.voice,
                                    language: data.language,
                                    include_youtube: data.include_youtube,
                                    tts_engine: data.tts_engine,
                                });
                            }
                        } else if (data.source === "freshrss") {
                            if (
                                !selection.freshrss.categories[
                                    data.categoryName
                                ]
                            ) {
                                selection.freshrss.categories[
                                    data.categoryName
                                ] = {};
                            }
                            if (
                                !selection.freshrss.categories[
                                    data.categoryName
                                ][data.feedId]
                            ) {
                                selection.freshrss.categories[
                                    data.categoryName
                                ][data.feedId] = [];
                            }

                            const category =
                                articlesData.freshrss.categories.find(
                                    (c) => c.name === data.categoryName,
                                );
                            if (category) {
                                const feed = category.feeds.find(
                                    (f) => f.id === data.feedId,
                                );
                                if (feed) {
                                    const fullArticle = feed.articles.find(
                                        (a) => a.id === data.originalId,
                                    );
                                    if (fullArticle) {
                                        selection.freshrss.categories[
                                            data.categoryName
                                        ][data.feedId].push({
                                            id: fullArticle.id,
                                            title: fullArticle.title,
                                            voice: data.voice,
                                            language: data.language,
                                            include_youtube:
                                                data.include_youtube,
                                            tts_engine: data.tts_engine,
                                        });
                                    }
                                }
                            }
                        }
                    }

                    showProgressModal();
                    updateProgress(0, count, "Iniciando conversi√≥n...");

                    const response = await fetch("/api/save-selection", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(selection),
                    });

                    const result = await response.json();

                    if (result.success) {
                        startProgressPolling();
                    } else {
                        hideProgressModal();
                        alert(`‚úó Error al guardar: ${result.message}`);
                    }
                } catch (error) {
                    console.error("Error:", error);
                    hideProgressModal();
                    alert("‚úó Error de conexi√≥n con el servidor.");
                }
            }

            let progressInterval = null;

            function showProgressModal() {
                document.getElementById("progressModal").style.display = "flex";
            }

            function hideProgressModal() {
                document.getElementById("progressModal").style.display = "none";
                if (progressInterval) {
                    clearInterval(progressInterval);
                    progressInterval = null;
                }
            }

            function updateProgress(current, total, message) {
                const percentage =
                    total > 0 ? Math.round((current / total) * 100) : 0;
                document.getElementById("progressBar").style.width =
                    percentage + "%";
                document.getElementById("progressText").textContent =
                    `${current}/${total} (${percentage}%)`;
                document.getElementById("progressMessage").textContent =
                    message;
            }

            async function startProgressPolling() {
                progressInterval = setInterval(async () => {
                    try {
                        const response = await fetch("/api/conversion-status");
                        const status = await response.json();

                        updateProgress(
                            status.progress,
                            status.total,
                            status.current_article,
                        );

                        if (!status.running) {
                            clearInterval(progressInterval);
                            progressInterval = null;

                            if (status.errors && status.errors.length > 0) {
                                alert(
                                    `‚ö† Conversi√≥n completada con errores:\n${status.errors.join("\n")}`,
                                );
                            } else {
                                setTimeout(() => {
                                    hideProgressModal();
                                    alert(
                                        `‚úì ¬°Conversi√≥n completada!\n\n${status.progress} art√≠culos convertidos a MP3`,
                                    );
                                }, 1000);
                            }
                        }
                    } catch (error) {
                        console.error("Error obteniendo estado:", error);
                    }
                }, 1000);
            }

            function downloadSelectionJson() {
                const count = Object.keys(selectedArticlesData).length;

                if (count === 0) {
                    alert("‚ö† No hay art√≠culos seleccionados");
                    return;
                }

                const selection = {
                    options: {
                        tts_engine: document.getElementById("tts-engine").value,
                        default_voice:
                            document.getElementById("default-voice").value,
                        default_language:
                            document.getElementById("default-language").value,
                        include_youtube:
                            document.getElementById("default-youtube").checked,
                        generate_feed: true,
                    },
                    wallabag: [],
                    freshrss: { categories: {} },
                };

                // Similar al saveToServer pero para descargar
                for (const [articleId, data] of Object.entries(
                    selectedArticlesData,
                )) {
                    if (data.source === "wallabag") {
                        const fullArticle = articlesData.wallabag.articles.find(
                            (a) => a.id == data.originalId,
                        );
                        if (fullArticle) {
                            selection.wallabag.push({
                                id: fullArticle.id,
                                title: fullArticle.title,
                                voice: data.voice,
                                language: data.language,
                                include_youtube: data.include_youtube,
                            });
                        }
                    }
                    // Similar para freshrss...
                }

                const blob = new Blob([JSON.stringify(selection, null, 2)], {
                    type: "application/json",
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "selection.json";
                a.click();
                URL.revokeObjectURL(url);

                alert(
                    `‚úì Archivo selection.json descargado\n\n${count} art√≠culos seleccionados`,
                );
            }

            function escapeHtml(text) {
                const div = document.createElement("div");
                div.textContent = text;
                return div.innerHTML;
            }

            // Cargar datos al inicio
            loadData();
        </script>
    </body>
</html>
