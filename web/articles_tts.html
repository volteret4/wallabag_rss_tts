<!doctype html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Articles to MP3 - Selector</title>
        <link
            href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Work+Sans:wght@300;400;600;800&display=swap"
            rel="stylesheet"
        />
        <style>
            :root {
                --bg-primary: #0a0a0a;
                --bg-secondary: #1a1a1a;
                --bg-tertiary: #2a2a2a;
                --bg-quaternary: #353535;
                --accent: #00ff88;
                --accent-dim: #00cc6a;
                --text-primary: #ffffff;
                --text-secondary: #aaaaaa;
                --text-dim: #666666;
                --border: #333333;
                --warning: #ffaa00;
                --danger: #ff4444;
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: "Work Sans", sans-serif;
                background: var(--bg-primary);
                color: var(--text-primary);
                line-height: 1.6;
                overflow-x: hidden;
            }

            .header {
                background: var(--bg-secondary);
                border-bottom: 2px solid var(--accent);
                padding: 2rem;
                position: sticky;
                top: 0;
                z-index: 100;
                backdrop-filter: blur(10px);
            }

            .header-content {
                max-width: 1400px;
                margin: 0 auto;
            }

            h1 {
                font-family: "Space Mono", monospace;
                font-size: 2.5rem;
                font-weight: 700;
                letter-spacing: -0.02em;
                margin-bottom: 0.5rem;
            }

            .accent-text {
                color: var(--accent);
            }

            .subtitle {
                color: var(--text-secondary);
                font-size: 1rem;
                font-weight: 300;
            }

            .stats-bar {
                display: flex;
                gap: 2rem;
                margin-top: 1.5rem;
                padding: 1rem;
                background: var(--bg-tertiary);
                border-radius: 4px;
                border-left: 3px solid var(--accent);
            }

            .stat {
                display: flex;
                flex-direction: column;
            }

            .stat-label {
                font-size: 0.75rem;
                color: var(--text-dim);
                text-transform: uppercase;
                letter-spacing: 0.1em;
                font-family: "Space Mono", monospace;
            }

            .stat-value {
                font-size: 1.5rem;
                font-weight: 800;
                color: var(--accent);
            }

            .container {
                max-width: 1400px;
                margin: 0 auto;
                padding: 2rem;
            }

            .controls {
                display: flex;
                gap: 1rem;
                margin-bottom: 2rem;
                flex-wrap: wrap;
            }

            .btn {
                padding: 0.75rem 1.5rem;
                background: var(--bg-tertiary);
                border: 2px solid var(--border);
                color: var(--text-primary);
                font-family: "Space Mono", monospace;
                font-size: 0.9rem;
                cursor: pointer;
                transition: all 0.2s ease;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }

            .btn:hover {
                border-color: var(--accent);
                background: var(--bg-secondary);
                transform: translateY(-2px);
            }

            .btn-primary {
                background: var(--accent);
                color: var(--bg-primary);
                border-color: var(--accent);
                font-weight: 700;
            }

            .btn-primary:hover {
                background: var(--accent-dim);
                border-color: var(--accent-dim);
            }

            .source-section {
                margin-bottom: 3rem;
                border: 1px solid var(--border);
                background: var(--bg-secondary);
                overflow: hidden;
            }

            .source-header {
                padding: 1.5rem;
                background: var(--bg-tertiary);
                display: flex;
                justify-content: space-between;
                align-items: center;
                cursor: pointer;
                user-select: none;
                transition: background 0.2s ease;
            }

            .source-header:hover {
                background: #333333;
            }

            .source-title {
                font-family: "Space Mono", monospace;
                font-size: 1.5rem;
                font-weight: 700;
                display: flex;
                align-items: center;
                gap: 1rem;
            }

            .source-badge {
                font-size: 0.75rem;
                padding: 0.25rem 0.75rem;
                background: var(--accent);
                color: var(--bg-primary);
                border-radius: 20px;
                font-weight: 700;
            }

            /* Categor√≠a */
            .category-group {
                border-bottom: 1px solid var(--border);
            }

            .category-group:last-child {
                border-bottom: none;
            }

            .category-header {
                padding: 1rem 1.5rem;
                background: var(--bg-secondary);
                display: flex;
                justify-content: space-between;
                align-items: center;
                cursor: pointer;
                user-select: none;
                transition: all 0.2s ease;
            }

            .category-header:hover {
                background: var(--bg-tertiary);
                padding-left: 2rem;
            }

            .category-name {
                font-weight: 600;
                font-size: 1.1rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .category-count {
                font-size: 0.8rem;
                color: var(--text-dim);
                font-family: "Space Mono", monospace;
            }

            /* Feed */
            .feed-group {
                border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            }

            .feed-group:last-child {
                border-bottom: none;
            }

            .feed-header {
                padding: 0.75rem 2.5rem;
                background: var(--bg-tertiary);
                display: flex;
                justify-content: space-between;
                align-items: center;
                cursor: pointer;
                user-select: none;
                transition: all 0.2s ease;
                border-left: 3px solid transparent;
            }

            .feed-header:hover {
                background: var(--bg-quaternary);
                padding-left: 3rem;
                border-left-color: var(--accent);
            }

            .feed-info {
                display: flex;
                align-items: center;
                gap: 1rem;
                flex: 1;
            }

            .feed-checkbox-wrapper {
                display: flex;
                align-items: center;
            }

            .feed-checkbox {
                width: 20px;
                height: 20px;
                cursor: pointer;
                accent-color: var(--accent);
            }

            .feed-name {
                font-weight: 500;
                font-size: 1rem;
                color: var(--text-secondary);
            }

            .feed-count {
                font-size: 0.75rem;
                color: var(--text-dim);
                font-family: "Space Mono", monospace;
            }

            .feed-toggle {
                color: var(--accent);
                font-size: 1.2rem;
                transition: transform 0.2s ease;
            }

            .feed-toggle.active {
                transform: rotate(90deg);
            }

            /* Articles list */
            .articles-list {
                display: none;
            }

            .articles-list.active {
                display: block;
            }

            .article-item {
                padding: 1rem 3.5rem;
                background: var(--bg-secondary);
                border-bottom: 1px solid rgba(255, 255, 255, 0.03);
                display: flex;
                gap: 1rem;
                align-items: start;
                cursor: pointer;
                transition: all 0.2s ease;
            }

            .article-item:hover {
                background: var(--bg-tertiary);
                padding-left: 4rem;
            }

            .checkbox-wrapper {
                padding-top: 0.2rem;
            }

            .checkbox {
                width: 18px;
                height: 18px;
                cursor: pointer;
                accent-color: var(--accent);
            }

            .article-content {
                flex: 1;
            }

            .article-title {
                font-weight: 500;
                margin-bottom: 0.5rem;
                color: var(--text-primary);
            }

            .article-meta {
                display: flex;
                gap: 1.5rem;
                font-size: 0.85rem;
                color: var(--text-dim);
                flex-wrap: wrap;
            }

            .meta-item {
                display: flex;
                align-items: center;
                gap: 0.25rem;
            }

            .toggle-icon {
                color: var(--accent);
                font-size: 1.2rem;
                transition: transform 0.2s ease;
            }

            .toggle-icon.active {
                transform: rotate(90deg);
            }

            .action-panel {
                position: fixed;
                bottom: 2rem;
                right: 2rem;
                background: var(--bg-tertiary);
                border: 2px solid var(--accent);
                padding: 1.5rem;
                border-radius: 4px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
                display: none;
                z-index: 1000;
            }

            .action-panel h3 {
                font-family: "Space Mono", monospace;
                font-size: 1rem;
                margin-bottom: 1rem;
                color: var(--accent);
            }

            .action-stats {
                margin-bottom: 1rem;
                font-size: 0.9rem;
                color: var(--text-secondary);
            }

            .action-buttons {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }

            .search-box {
                margin-bottom: 1.5rem;
            }

            .search-box input {
                width: 100%;
                padding: 0.75rem;
                background: var(--bg-tertiary);
                border: 1px solid var(--border);
                color: var(--text-primary);
                font-family: "Work Sans", sans-serif;
                font-size: 1rem;
                transition: border-color 0.2s ease;
            }

            .search-box input:focus {
                outline: none;
                border-color: var(--accent);
            }
        </style>
    </head>
    <body>
        <div class="header">
            <div class="header-content">
                <h1>
                    üìö Articles to
                    <span class="accent-text">MP3</span>
                </h1>
                <p class="subtitle">
                    Selecciona los art√≠culos que quieres convertir en audio
                </p>
                <div class="stats-bar">
                    <div class="stat">
                        <span class="stat-label">Total Art√≠culos</span>
                        <span class="stat-value" id="totalArticles">0</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Seleccionados</span>
                        <span class="stat-value" id="selectedCount">0</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Palabras</span>
                        <span class="stat-value" id="estimatedWords">0</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="search-box">
                <input
                    type="text"
                    id="searchFilter"
                    placeholder="üîç Buscar art√≠culos por t√≠tulo..."
                    oninput="filterArticles()"
                />
            </div>

            <div class="controls">
                <button class="btn" onclick="selectAll()">
                    ‚úì Seleccionar Todo
                </button>
                <button class="btn" onclick="deselectAll()">
                    ‚úó Deseleccionar Todo
                </button>
                <button class="btn" onclick="loadData()">
                    üîÑ Recargar Datos
                </button>
            </div>

            <div id="articlesContainer">
                <div
                    style="
                        text-align: center;
                        padding: 4rem;
                        color: var(--text-dim);
                    "
                >
                    <p style="font-size: 1.2rem">Cargando datos...</p>
                    <p style="margin-top: 1rem">
                        Aseg√∫rate de haber ejecutado: python3 fetch_articles.py
                    </p>
                </div>
            </div>
        </div>

        <div id="actionPanel" class="action-panel">
            <h3>‚ö° Acciones</h3>
            <div class="action-stats">
                <div>
                    <span id="actionSelectedCount">0</span> art√≠culos
                    seleccionados
                </div>
                <div><span id="actionWords">0</span> palabras estimadas</div>
            </div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="saveToServer()">
                    üíæ Guardar en Servidor
                </button>
                <button class="btn" onclick="downloadSelectionJson()">
                    üì• Descargar JSON
                </button>
            </div>
        </div>

        <script>
            let articlesData = null;

            async function loadData() {
                try {
                    const response = await fetch("articles_data.json");
                    articlesData = await response.json();
                    renderArticles();
                    updateStats();
                } catch (error) {
                    console.error("Error al cargar datos:", error);
                    document.getElementById("articlesContainer").innerHTML = `
                        <div style="text-align: center; padding: 4rem; color: var(--danger);">
                            <p style="font-size: 1.2rem;">‚úó Error al cargar articles_data.json</p>
                            <p style="margin-top: 1rem;">Ejecuta: python3 fetch_articles.py</p>
                        </div>
                    `;
                }
            }

            function renderArticles() {
                let html = "";

                // Wallabag
                if (
                    articlesData.wallabag.enabled &&
                    articlesData.wallabag.articles.length > 0
                ) {
                    html += renderWallabagSection();
                }

                // FreshRSS
                if (
                    articlesData.freshrss.enabled &&
                    articlesData.freshrss.categories.length > 0
                ) {
                    html += renderFreshRSSSection();
                }

                document.getElementById("articlesContainer").innerHTML = html;
            }

            function renderWallabagSection() {
                const articles = articlesData.wallabag.articles;
                let html = `
                <div class="source-section">
                    <div class="source-header" onclick="toggleSection('wallabag')">
                        <div class="source-title">
                            üìñ Wallabag
                            <span class="source-badge">${articles.length}</span>
                        </div>
                        <span class="toggle-icon" id="toggle-wallabag">‚ñ∂</span>
                    </div>
                    <div class="articles-list" id="section-wallabag">
                `;

                articles.forEach((article) => {
                    const id = `wallabag-${article.id}`;
                    html += `
                    <div class="article-item" onclick="toggleArticle('${id}', event)">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" class="checkbox" id="${id}"
                                   data-source="wallabag"
                                   data-title="${escapeHtml(article.title)}"
                                   data-words="${article.word_count}"
                                   onchange="updateStats()">
                        </div>
                        <div class="article-content">
                            <div class="article-title">${article.title}</div>
                            <div class="article-meta">
                                <span class="meta-item">üìä ${article.word_count} palabras</span>
                                <span class="meta-item">üìù ${article.char_count} caracteres</span>
                                ${article.tags.length > 0 ? `<span class="meta-item">üè∑ ${article.tags.join(", ")}</span>` : ""}
                            </div>
                        </div>
                    </div>
                    `;
                });

                html += "</div></div>";
                return html;
            }

            function renderFreshRSSSection() {
                const categories = articlesData.freshrss.categories;
                let html = `
                <div class="source-section">
                    <div class="source-header" onclick="toggleSection('freshrss')">
                        <div class="source-title">
                            üì∞ FreshRSS
                            <span class="source-badge">${categories.length} categor√≠as</span>
                        </div>
                        <span class="toggle-icon" id="toggle-freshrss">‚ñ∂</span>
                    </div>
                    <div class="articles-list" id="section-freshrss">
                `;

                categories.forEach((category) => {
                    const totalArticles = category.feeds.reduce(
                        (sum, feed) => sum + feed.article_count,
                        0,
                    );

                    html += `
                    <div class="category-group">
                        <div class="category-header" onclick="toggleCategory('${category.name}')">
                            <div class="category-name">
                                <span class="toggle-icon" id="toggle-cat-${category.name}">‚ñ∂</span>
                                üìÅ ${category.name}
                            </div>
                            <div class="category-count">${category.feeds.length} feeds ‚Ä¢ ${totalArticles} art√≠culos</div>
                        </div>
                        <div class="articles-list" id="category-${category.name}">
                    `;

                    // Renderizar feeds dentro de la categor√≠a
                    category.feeds.forEach((feed) => {
                        const feedId =
                            `feed-${category.name}-${feed.id}`.replace(
                                /[^a-zA-Z0-9-_]/g,
                                "_",
                            );

                        html += `
                        <div class="feed-group">
                            <div class="feed-header" onclick="toggleFeed('${feedId}', event)">
                                <div class="feed-info">
                                    <div class="feed-checkbox-wrapper" onclick="event.stopPropagation()">
                                        <input type="checkbox" class="feed-checkbox" id="checkbox-${feedId}"
                                               data-feed-id="${feedId}"
                                               onchange="toggleFeedSelection('${feedId}', '${category.name}', '${escapeHtml(feed.id)}')">
                                    </div>
                                    <div class="feed-name">üì∞ ${feed.title}</div>
                                    <div class="feed-count">${feed.article_count} art√≠culos</div>
                                </div>
                                <span class="feed-toggle" id="toggle-${feedId}">‚ñ∂</span>
                            </div>
                            <div class="articles-list" id="${feedId}">
                        `;

                        // Renderizar art√≠culos del feed
                        feed.articles.forEach((article) => {
                            const articleId =
                                `article-${feedId}-${article.id}`.replace(
                                    /[^a-zA-Z0-9-_]/g,
                                    "_",
                                );

                            html += `
                            <div class="article-item" onclick="toggleArticle('${articleId}', event)">
                                <div class="checkbox-wrapper">
                                    <input type="checkbox" class="checkbox article-checkbox" id="${articleId}"
                                           data-source="freshrss"
                                           data-category="${category.name}"
                                           data-feed-id="${feedId}"
                                           data-original-feed-id="${feed.id}"
                                           data-article-id="${article.id}"
                                           data-title="${escapeHtml(article.title)}"
                                           data-words="${article.word_count}"
                                           onchange="updateStats(); updateFeedCheckbox('${feedId}')">
                                </div>
                                <div class="article-content">
                                    <div class="article-title">${article.title}</div>
                                    <div class="article-meta">
                                        <span class="meta-item">üìä ${article.word_count} palabras</span>
                                        <span class="meta-item">üìù ${article.char_count} caracteres</span>
                                        ${article.author ? `<span class="meta-item">‚úçÔ∏è ${article.author}</span>` : ""}
                                    </div>
                                </div>
                            </div>
                            `;
                        });

                        html += "</div></div>"; // Cerrar feed
                    });

                    html += "</div></div>"; // Cerrar categor√≠a
                });

                html += "</div></div>";
                return html;
            }

            function toggleSection(section) {
                const content = document.getElementById(`section-${section}`);
                const icon = document.getElementById(`toggle-${section}`);
                content.classList.toggle("active");
                icon.classList.toggle("active");
            }

            function toggleCategory(category) {
                const content = document.getElementById(`category-${category}`);
                const icon = document.getElementById(`toggle-cat-${category}`);
                content.classList.toggle("active");
                icon.classList.toggle("active");
            }

            function toggleFeed(feedId, event) {
                // No toggle si el click es en el checkbox
                if (event.target.type === "checkbox") return;

                const content = document.getElementById(feedId);
                const icon = document.getElementById(`toggle-${feedId}`);
                content.classList.toggle("active");
                icon.classList.toggle("active");
            }

            function toggleFeedSelection(feedId, category, originalFeedId) {
                const feedCheckbox = document.getElementById(
                    `checkbox-${feedId}`,
                );
                const isChecked = feedCheckbox.checked;

                // Seleccionar/deseleccionar todos los art√≠culos del feed
                const articles = document.querySelectorAll(
                    `input.article-checkbox[data-feed-id="${feedId}"]`,
                );
                articles.forEach((article) => {
                    article.checked = isChecked;
                });

                updateStats();
            }

            function updateFeedCheckbox(feedId) {
                const feedCheckbox = document.getElementById(
                    `checkbox-${feedId}`,
                );
                const articles = document.querySelectorAll(
                    `input.article-checkbox[data-feed-id="${feedId}"]`,
                );

                if (articles.length === 0) return;

                const checkedArticles = Array.from(articles).filter(
                    (a) => a.checked,
                );

                if (checkedArticles.length === 0) {
                    feedCheckbox.checked = false;
                    feedCheckbox.indeterminate = false;
                } else if (checkedArticles.length === articles.length) {
                    feedCheckbox.checked = true;
                    feedCheckbox.indeterminate = false;
                } else {
                    feedCheckbox.checked = false;
                    feedCheckbox.indeterminate = true;
                }
            }

            function toggleArticle(id, event) {
                if (event.target.type === "checkbox") return;
                const checkbox = document.getElementById(id);
                checkbox.checked = !checkbox.checked;
                updateStats();

                // Actualizar el checkbox del feed padre
                const feedId = checkbox.dataset.feedId;
                if (feedId) {
                    updateFeedCheckbox(feedId);
                }
            }

            function selectAll() {
                document.querySelectorAll(".checkbox").forEach((cb) => {
                    cb.checked = true;
                });
                document.querySelectorAll(".feed-checkbox").forEach((cb) => {
                    cb.checked = true;
                    cb.indeterminate = false;
                });
                updateStats();
            }

            function deselectAll() {
                document.querySelectorAll(".checkbox").forEach((cb) => {
                    cb.checked = false;
                });
                document.querySelectorAll(".feed-checkbox").forEach((cb) => {
                    cb.checked = false;
                    cb.indeterminate = false;
                });
                updateStats();
            }

            function updateStats() {
                const checkboxes =
                    document.querySelectorAll(".checkbox:checked");
                const count = checkboxes.length;
                let totalWords = 0;

                checkboxes.forEach((cb) => {
                    totalWords += parseInt(cb.dataset.words || 0);
                });

                document.getElementById("selectedCount").textContent = count;
                document.getElementById("actionSelectedCount").textContent =
                    count;
                document.getElementById("estimatedWords").textContent =
                    totalWords.toLocaleString();
                document.getElementById("actionWords").textContent =
                    totalWords.toLocaleString();

                document.getElementById("actionPanel").style.display =
                    count > 0 ? "block" : "none";

                const totalArticles =
                    document.querySelectorAll(".checkbox").length;
                document.getElementById("totalArticles").textContent =
                    totalArticles;
            }

            function filterArticles() {
                const query = document
                    .getElementById("searchFilter")
                    .value.toLowerCase();
                document.querySelectorAll(".article-item").forEach((item) => {
                    const title = item
                        .querySelector(".article-title")
                        .textContent.toLowerCase();
                    item.style.display = title.includes(query)
                        ? "flex"
                        : "none";
                });
            }

            function getSelectionData() {
                const selected = {
                    wallabag: [],
                    freshrss: {
                        categories: {},
                    },
                };

                document.querySelectorAll(".checkbox:checked").forEach((cb) => {
                    const source = cb.dataset.source;

                    if (source === "wallabag") {
                        const articleId = cb.id.replace("wallabag-", "");
                        const article = articlesData.wallabag.articles.find(
                            (a) => a.id == articleId,
                        );
                        if (article) {
                            selected.wallabag.push(article);
                        }
                    } else if (source === "freshrss") {
                        const category = cb.dataset.category;
                        const originalFeedId = cb.dataset.originalFeedId;
                        const articleId = cb.dataset.articleId;

                        if (!selected.freshrss.categories[category]) {
                            selected.freshrss.categories[category] = {};
                        }
                        if (
                            !selected.freshrss.categories[category][
                                originalFeedId
                            ]
                        ) {
                            selected.freshrss.categories[category][
                                originalFeedId
                            ] = [];
                        }

                        // Buscar el art√≠culo en los datos
                        const categoryData =
                            articlesData.freshrss.categories.find(
                                (c) => c.name === category,
                            );
                        if (categoryData) {
                            const feedData = categoryData.feeds.find(
                                (f) => f.id === originalFeedId,
                            );
                            if (feedData) {
                                const article = feedData.articles.find(
                                    (a) => a.id === articleId,
                                );
                                if (article) {
                                    selected.freshrss.categories[category][
                                        originalFeedId
                                    ].push(article);
                                }
                            }
                        }
                    }
                });

                return selected;
            }

            async function saveToServer() {
                const selected = getSelectionData();
                const count =
                    document.querySelectorAll(".checkbox:checked").length;

                if (count === 0) {
                    alert("‚ö† No hay art√≠culos seleccionados");
                    return;
                }

                try {
                    const response = await fetch("/save-selection", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(selected),
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert(
                            `‚úì Guardado en el servidor!\n\n${count} art√≠culos guardados en:\n${result.path}\n\nAhora puedes ejecutar:\npython3 process_selection.py`,
                        );
                    } else {
                        alert(`‚úó Error al guardar: ${result.message}`);
                    }
                } catch (error) {
                    console.error("Error:", error);
                    alert(
                        `‚úó Error de conexi√≥n con el servidor.\n\n¬øEst√° el servidor corriendo?\nEjecuta: python3 server.py`,
                    );
                }
            }

            function downloadSelectionJson() {
                const selected = getSelectionData();
                const count =
                    document.querySelectorAll(".checkbox:checked").length;

                if (count === 0) {
                    alert("‚ö† No hay art√≠culos seleccionados");
                    return;
                }

                const blob = new Blob([JSON.stringify(selected, null, 2)], {
                    type: "application/json",
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "selection.json";
                a.click();
                URL.revokeObjectURL(url);

                alert(
                    `‚úì Archivo selection.json descargado\n\n${count} art√≠culos seleccionados`,
                );
            }

            function escapeHtml(text) {
                const div = document.createElement("div");
                div.textContent = text;
                return div.innerHTML;
            }

            // Cargar datos al inicio
            loadData();
        </script>
    </body>
</html>
