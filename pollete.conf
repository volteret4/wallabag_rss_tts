# ------------------------------------ HTTP to HTTPS redirect ------------------------------------

server {
    listen 80;
    listen [::]:80;

    # Any hosts that should redirect HTTP to HTTPS (Cloudflare hosts not needed)
    server_name *.pollete.duckdns.org;
    return 301 https://$host$request_uri;
}

# ------------------------------------------ PROXY HOSTS ------------------------------------------

# redlib
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name redlib.pollete.duckdns.org;

    include /config/nginx/ssl.conf;
    include /config/nginx/proxy.conf;

    location / {
        proxy_pass http://192.168.1.53:8480;
    }
}

# rss
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name rss.pollete.duckdns.org;

    include /config/nginx/ssl.conf;
    include /config/nginx/proxy.conf;

    location / {
        proxy_pass http://192.168.1.133:8145;
    }
}

# yt
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name yt.pollete.duckdns.org;

    include /config/nginx/ssl.conf;
    include /config/nginx/proxy.conf;

    location / {
        proxy_pass http://192.168.1.53:3000;
    }
}

# hass
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name hass.pollete.duckdns.org;

    include /config/nginx/ssl.conf;
    include /config/nginx/proxy.conf;

    location / {
        proxy_pass http://192.168.1.112:8123;
    }
}

# wallabag
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name wallabag.pollete.duckdns.org;

    include /config/nginx/ssl.conf;
    include /config/nginx/proxy.conf;

    location / {
        proxy_pass http://192.168.1.133:808;
    }
}

# radicale
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name radicale.pollete.duckdns.org;

    include /config/nginx/ssl.conf;
    include /config/nginx/proxy.conf;

    location / {
        proxy_pass http://192.168.1.133:5232;
    }
}

# airsonic
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name airsonic.pollete.duckdns.org;

    include /config/nginx/ssl.conf;
    include /config/nginx/proxy.conf;

    location / {
        proxy_pass http://192.168.1.133:4040;
    }
}

# swag
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name swag.pollete.duckdns.org;

    include /config/nginx/ssl.conf;
    include /config/nginx/proxy.conf;

    location / {
        proxy_pass http://192.168.1.133:81;
    }
}

# kopia_pepe
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name kopia_pepe.pollete.duckdns.org;

    include /config/nginx/ssl.conf;
    include /config/nginx/proxy.conf;

    location / {
        proxy_pass http://192.168.1.133:51515;
    }
}

# nodered
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name nodered.pollete.duckdns.org;

    include /config/nginx/ssl.conf;
    include /config/nginx/proxy.conf;

    location / {
        proxy_pass http://192.168.1.133:1880;
    }
}
# syncthing
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name sync_pepe.pollete.duckdns.org;

    include /config/nginx/ssl.conf;
    include /config/nginx/proxy.conf;

    location / {
        proxy_pass http://192.168.1.133:8384;
    }
}

# ntfy
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name ntfy.pollete.duckdns.org;

    include /config/nginx/ssl.conf;
    include /config/nginx/proxy.conf;

    location / {
        proxy_pass http://192.168.1.133:8983;
    }
}

# homepage
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name casa.pollete.duckdns.org;

    include /config/nginx/ssl.conf;
    include /config/nginx/proxy.conf;

    location / {
        proxy_pass http://192.168.1.133:3130;
    }
}

# searchx
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name searchx.pollete.duckdns.org;

    include /config/nginx/ssl.conf;
    include /config/nginx/proxy.conf;

    location / {
        proxy_pass http://192.168.1.53:8485;
    }
}


# podcas-tts


server {
    listen 443 ssl;
    listen [::]:443 ssl;

    server_name podcast.pollete.duckdns.org;

    include /config/nginx/ssl.conf;
   
    client_max_body_size 0;

    # Ruta donde se guardan los archivos de audio
    # IMPORTANTE: Cambia esto a la ruta real en tu servidor
    # Debe coincidir con el directorio --output del script
    root /config/www/podcast-tts;

    # Logging
    access_log /config/log/nginx/podcast-access.log;
    error_log /config/log/nginx/podcast-error.log;

    # API Flask - proxy al servidor Python
    location /api/ {
        # Hacer proxy al servidor Flask corriendo en el host
        proxy_pass http://192.168.1.133:5000/api/;
        
        # Headers necesarios para Flask
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Para SSE/streaming si lo usas
        proxy_buffering off;
        proxy_cache off;
        
        # Timeouts largos para la conversión
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
    }

    location / {
        # Habilitar listado de directorio (opcional)
        # autoindex on;
        # autoindex_exact_size off;
        # autoindex_localtime on;

        # Servir index.html o podcast.xml por defecto
        index podcast.xml index.html;
        

        # Headers para mejor compatibilidad con apps de podcasts
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
        add_header Access-Control-Allow-Headers "Range";
        add_header Access-Control-Expose-Headers "Content-Length, Content-Range";
        
        # Habilitar CORS para podcasts
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
            add_header Access-Control-Max-Age 1728000;
            add_header Content-Type 'text/plain; charset=utf-8';
            add_header Content-Length 0;
            return 204;
        }
    }

    # Configuración específica para el feed RSS/XML
    location ~ \.(xml|rss)$ {
        add_header Content-Type "application/rss+xml; charset=utf-8";
        add_header Cache-Control "no-cache, must-revalidate";
        add_header Access-Control-Allow-Origin *;
        
        # No cachear el feed para que siempre esté actualizado
        expires -1;
    }

    # Feed RSS y archivos de audio
    location /audio_articles/ {
        alias /config/www/podcast-tts/audio_articles/;
        autoindex on;
        autoindex_exact_size off;
        autoindex_localtime on;
        
        # Headers para podcasts
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
    }

    # Configuración específica para archivos MP3
    location ~ \.(mp3|m4a|ogg|opus)$ {
        # Headers para streaming de audio
        add_header Content-Type "audio/mpeg";
        add_header Accept-Ranges bytes;
        add_header Access-Control-Allow-Origin *;
        
        # Cache de 7 días para archivos de audio
        expires 7d;
        add_header Cache-Control "public, immutable";
        
        # Soporte para range requests (importante para streaming)
        add_header Access-Control-Expose-Headers "Content-Length, Content-Range";
    }

    # Seguridad: bloquear archivos sensibles
    location ~ /\. {
        deny all;
    }
    
    location ~ \.py$ {
        deny all;
    }
    
    location ~ config\.json$ {
        deny all;
    }
}
